<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORIA - AperturaMaster</title>
    
    <!-- Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- Polyfills para compatibilidad -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Import Map Actualizado a versiones estables y compatibles -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0?dev",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?dev",
            "lucide-react": "https://esm.sh/lucide-react@0.303.0?dev",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root">
        <!-- Loader inicial -->
        <div class="h-screen flex flex-col items-center justify-center text-slate-400 gap-4">
            <div class="loading-spinner"></div>
            <p class="text-sm">Iniciando Sistema CORIA...</p>
        </div>
    </div>

    <!-- Script Principal -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, Component } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp, getApps, getApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            serverTimestamp,
            query,
            orderBy
        } from 'firebase/firestore';
        import { 
            LayoutDashboard, Building2, Building, AlertTriangle, Plus, Search, CheckCircle2, 
            XCircle, Globe, Phone, FileText, Users, MapPin, Trash2, Edit, Clock, Calendar, 
            Crown, ChevronDown, ChevronUp, MoreVertical, ClipboardList, ExternalLink, Info, 
            LifeBuoy, MessageSquare, AlertCircle, CheckSquare, Send, Download, ShieldAlert, 
            Eye, History, Settings, Save, RefreshCw, Bug
        } from 'lucide-react';

        // --- ERROR BOUNDARY (Caja Negra para capturar errores de React) ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("React Error Caught:", error, errorInfo);
                this.setState({ error, errorInfo });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
                            <div className="bg-white p-8 rounded-xl shadow-xl max-w-2xl w-full border-2 border-red-200">
                                <div className="flex items-center gap-3 mb-4 text-red-600">
                                    <Bug size={32} />
                                    <h1 className="text-2xl font-bold">Algo salió mal en la aplicación</h1>
                                </div>
                                <p className="text-slate-600 mb-4">La aplicación ha detectado un error interno. Por favor, toma una captura de este mensaje.</p>
                                
                                <div className="bg-slate-900 text-slate-50 p-4 rounded-lg overflow-auto max-h-64 font-mono text-xs mb-6">
                                    <p className="font-bold text-red-300 mb-2">{this.state.error && this.state.error.toString()}</p>
                                    <pre className="opacity-70">{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                                </div>

                                <div className="flex gap-4">
                                    <button onClick={() => window.location.reload()} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700">Recargar Página</button>
                                    <button onClick={() => { localStorage.removeItem('apertura_firebase_config'); window.location.reload(); }} className="text-slate-500 hover:text-red-500 underline text-sm">Borrar Configuración y Reiniciar</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- GESTIÓN DE CONFIGURACIÓN ---
        const getStoredConfig = () => {
            try {
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
                const hardcodedConfig = { apiKey: "AIzaSyA9gk593APfDsDIG3VGTclmzs8aO9oLgJg", authDomain: "control-aperturas-27baf.firebaseapp.com", projectId: "control-aperturas-27baf", storageBucket: "control-aperturas-27baf.firebasestorage.app", messagingSenderId: "291057486602", appId: "1:291057486602:web:0d05d616ea84cd69e448f3" };
                if (hardcodedConfig.apiKey !== "TU_API_KEY_AQUI") return hardcodedConfig;
                const local = localStorage.getItem('apertura_firebase_config');
                if (local) return JSON.parse(local);
            } catch (e) { console.error("Error config:", e); }
            return null;
        };

        const config = getStoredConfig();
        let app, auth, db, isConfigured = false;

        if (config && config.apiKey) {
            try {
                if (!getApps().length) app = initializeApp(config);
                else app = getApp();
                auth = getAuth(app);
                db = getFirestore(app);
                isConfigured = true;
            } catch (e) { console.error("Init Error:", e); }
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'coria-app-v1';

        // --- UTILITIES ---
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch(e) { return '-'; }
        };

        const formatDateTime = (timestamp) => {
            if (!timestamp) return '-';
            try {
                const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch(e) { return '-'; }
        };

        const getDaysDiff = (dateString) => {
            if (!dateString) return null;
            try { return Math.ceil((new Date(dateString) - new Date()) / (1000 * 60 * 60 * 24)); } catch(e) { return null; }
        };

        const getDaysSince = (dateString) => {
            if (!dateString) return 999;
            try { return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24)); } catch(e) { return 999; }
        };

        // --- PANTALLA CONFIGURACIÓN ---
        function ConfigScreen() {
            const [jsonInput, setJsonInput] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let clean = jsonInput.includes('=') ? jsonInput.substring(jsonInput.indexOf('=') + 1) : jsonInput;
                    clean = clean.trim();
                    if (clean.endsWith(';')) clean = clean.slice(0, -1);
                    const parsed = JSON.parse(clean);
                    if (!parsed.apiKey) throw new Error("Falta apiKey");
                    localStorage.setItem('apertura_firebase_config', JSON.stringify(parsed));
                    window.location.reload();
                } catch (e) { setError("JSON Inválido: " + e.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border">
                        <div className="text-center mb-6">
                            <div className="bg-indigo-100 p-3 rounded-full inline-block mb-3"><Settings className="w-8 h-8 text-indigo-600" /></div>
                            <h1 className="text-2xl font-bold text-slate-800">Conectar Base de Datos</h1>
                            <p className="text-slate-500 text-sm mt-2">Pega tu configuración de Firebase.</p>
                        </div>
                        <textarea className="w-full border rounded p-3 text-xs font-mono h-32 mb-4 bg-slate-50" placeholder='{ "apiKey": "...", ... }' value={jsonInput} onChange={e => setJsonInput(e.target.value)}></textarea>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm mb-4 flex gap-2"><AlertCircle size={16}/>{error}</div>}
                        <button onClick={handleSave} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Guardar y Conectar</button>
                    </div>
                </div>
            );
        }

        // --- APP PRINCIPAL ---
        function AppContent() {
            if (!isConfigured) return <ConfigScreen />;

            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('admin');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [offices, setOffices] = useState([]);
            const [tickets, setTickets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState(''); 
            
            const [showOfficeModal, setShowOfficeModal] = useState(false);
            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [showTicketModal, setShowTicketModal] = useState(false);
            
            const [currentOffice, setCurrentOffice] = useState(null);
            const [currentCompany, setCurrentCompany] = useState(null);
            const [currentTicket, setCurrentTicket] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const [officeForm, setOfficeForm] = useState({ name: '', address: '', contractEndDate: '', landlordName: '', notes: '', companies: [] });
            const [companyForm, setCompanyForm] = useState({ name: '', isLeader: false, interior: '', assignmentDate: new Date().toISOString().split('T')[0], checklist: { telmexProof: false, fiscalAddressEmail: false, interiorAssigned: false, emailCreated: false, webCreated: false, phoneInstalled: false }, webUrl: '', domainExpirationDate: '', lastWebCheck: '', phoneNumber: '', lastPhoneCheck: '' });
            const [ticketForm, setTicketForm] = useState({ officeId: '', officeName: '', companyName: '', type: 'falla_tecnica', category: 'internet', priority: 'media', status: 'pendiente', description: '', updates: [], newUpdate: '' });

            useEffect(() => {
                const init = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Auth Error:", e); 
                        setErrorMsg("Error Autenticación: " + e.message);
                        setLoading(false); 
                    }
                };
                init();
                const unsubscribe = onAuthStateChanged(auth, u => { 
                    setUser(u); 
                    if(!u) setLoading(false); 
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if(!user) return;
                
                let officesLoaded = false, ticketsLoaded = false;
                const checkLoading = () => { if(officesLoaded && ticketsLoaded) setLoading(false); };

                const unsub1 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'offices'), 
                    (s) => { 
                        setOffices(s.docs.map(d=>({id:d.id, ...d.data()}))); 
                        officesLoaded = true; checkLoading();
                    },
                    (err) => { 
                        console.error("Offices Error:", err); 
                        setErrorMsg(prev => prev + " [Oficinas: " + err.code + "]"); 
                        officesLoaded = true; checkLoading(); 
                    }
                );

                const unsub2 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tickets'), 
                    (s) => { 
                        const t = s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                        setTickets(t); 
                        ticketsLoaded = true; checkLoading();
                    },
                    (err) => { 
                        console.error("Tickets Error:", err); 
                        setErrorMsg(prev => prev + " [Tickets: " + err.code + "]"); 
                        ticketsLoaded = true; checkLoading(); 
                    }
                );

                return () => { try { unsub1(); unsub2(); } catch(e){} };
            }, [user]);

            const canEdit = userRole === 'admin';
            const canDelete = userRole === 'admin';

            // Safe Data Access Helper
            const safeCompanies = (o) => Array.isArray(o?.companies) ? o.companies : [];

            // Actions
            const saveOffice = async (e) => { 
                e.preventDefault(); 
                try {
                    const ref = collection(db, 'artifacts', appId, 'public', 'data', 'offices'); 
                    const data = {...officeForm, updatedAt: serverTimestamp()}; 
                    if(currentOffice) await updateDoc(doc(ref, currentOffice.id), data); 
                    else await addDoc(ref, {...data, createdAt: serverTimestamp(), companies:[]}); 
                    setShowOfficeModal(false); 
                } catch(err) { alert("Error guardando: " + err.message); }
            };

            const saveCompany = async (e) => { 
                e.preventDefault(); 
                if(!currentOffice) return; 
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'offices', currentOffice.id); 
                    let list = [...safeCompanies(currentOffice)]; 
                    if(companyForm.isLeader) list = list.map(c=>({...c, isLeader:false})); 
                    if(currentCompany) list[currentCompany.index] = companyForm; 
                    else list.push(companyForm); 
                    await updateDoc(ref, {companies: list}); 
                    setShowCompanyModal(false); 
                } catch(err) { alert("Error guardando empresa: " + err.message); }
            };

            const saveTicket = async (e) => { 
                e.preventDefault(); 
                try {
                    const ref = collection(db, 'artifacts', appId, 'public', 'data', 'tickets'); 
                    const data = {...ticketForm, updatedAt: serverTimestamp()}; 
                    if(data.newUpdate){ data.updates = [...(data.updates||[]), {text: data.newUpdate, date: new Date().toISOString(), author: userRole}]; delete data.newUpdate; } 
                    if(currentTicket) await updateDoc(doc(ref, currentTicket.id), data); 
                    else await addDoc(ref, {...data, createdAt: serverTimestamp()}); 
                    setShowTicketModal(false); 
                } catch(err) { alert("Error ticket: " + err.message); }
            };

            const deleteOffice = async (id) => { if(confirm("¿Eliminar oficina?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'offices', id)); };
            const deleteCompany = async (oid, idx) => { if(confirm("¿Eliminar empresa?")) { const o = offices.find(x=>x.id===oid); const list = safeCompanies(o).filter((_,i)=>i!==idx); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'offices', oid), {companies: list}); }};
            const deleteTicket = async (id) => { if(confirm("¿Eliminar ticket?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tickets', id)); };
            const performQuickCheck = async (oid, idx, type) => { if(!canEdit) return; const o = offices.find(x=>x.id===oid); const list = [...safeCompanies(o)]; const key = type==='phone'?'lastPhoneCheck':'lastWebCheck'; list[idx][key] = new Date().toISOString().split('T')[0]; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'offices', oid), {companies: list}); };

            const exportExcel = () => {
                let csv = "ID,Oficina,Direccion,Vencimiento,Empresa,Interior,Telefono,Web\n";
                offices.forEach(o => {
                    const comps = safeCompanies(o);
                    if(!comps.length) csv += `"${o.id}","${o.name}","${o.address}","${formatDate(o.contractEndDate)}",,,,\n`;
                    else comps.forEach(c => csv += `"${o.id}","${o.name}","${o.address}","${formatDate(o.contractEndDate)}","${c.name}","${c.interior}","${c.phoneNumber}","${c.webUrl}"\n`);
                });
                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([`\uFEFF${csv}`], {type:'text/csv'})); link.download = "Reporte.csv"; link.click();
            };

            const alerts = useMemo(() => {
                const list = [];
                offices.forEach(o => {
                    if(o.contractEndDate && getDaysDiff(o.contractEndDate) <= 90) list.push({type:'contract', priority:1, title:`Contrato: ${o.name}`, msg:`Vence el ${formatDate(o.contractEndDate)}`, data:o});
                    safeCompanies(o).forEach((c,i) => {
                        if(c.domainExpirationDate && getDaysDiff(c.domainExpirationDate) <= 90) list.push({type:'domain', priority:2, title:`Dominio: ${c.name}`, msg:`Vence el ${formatDate(c.domainExpirationDate)}`, data:{oid:o.id, idx:i, c}});
                        if(c.checklist?.phoneInstalled && getDaysSince(c.lastPhoneCheck) >= 15) list.push({type:'phone', actionType:'quickCheckPhone', priority:1, title:`Teléfono: ${c.name}`, msg:`Revisar línea (última: ${formatDate(c.lastPhoneCheck)})`, data:{officeId:o.id, companyIndex:i}});
                        if(c.checklist?.webCreated && getDaysSince(c.lastWebCheck) >= 30) list.push({type:'web', actionType:'quickCheckWeb', priority:3, title:`Web: ${c.name}`, msg:`Revisar sitio (última: ${formatDate(c.lastWebCheck)})`, data:{officeId:o.id, companyIndex:i}});
                    });
                });
                return list.sort((a,b)=>a.priority-b.priority);
            }, [offices]);

            if (errorMsg && loading === false) return (
                <div className="h-screen flex items-center justify-center p-6 bg-slate-50">
                    <div className="bg-white p-8 rounded-xl shadow-xl max-w-md text-center border-2 border-red-100">
                        <div className="bg-red-100 p-4 rounded-full inline-block mb-4"><ShieldAlert className="w-10 h-10 text-red-600"/></div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">Error de Conexión</h2>
                        <p className="text-sm text-slate-600 mb-6 bg-slate-50 p-3 rounded border font-mono break-all">{errorMsg}</p>
                        <div className="flex flex-col gap-2">
                            <button onClick={()=>window.location.reload()} className="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700">Reintentar</button>
                            <button onClick={()=>{localStorage.removeItem('apertura_firebase_config'); window.location.reload()}} className="w-full text-slate-500 py-2 text-sm hover:text-slate-700 underline">Cerrar Sesión / Cambiar DB</button>
                        </div>
                    </div>
                </div>
            );

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="loading-spinner"></div></div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* SIDEBAR */}
                    <aside className="w-64 bg-slate-900 text-white flex flex-col hidden md:flex">
                        <div className="p-6 border-b border-slate-800 flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg"><Building2 size={24}/></div>
                            <h1 className="font-bold text-lg">CORIA<br/><span className="text-indigo-400 text-sm">Aperturas</span></h1>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex gap-3 p-3 rounded ${activeTab==='dashboard'?'bg-indigo-600':'hover:bg-slate-800'}`}><LayoutDashboard/> Tablero</button>
                            <button onClick={()=>setActiveTab('offices')} className={`w-full flex gap-3 p-3 rounded ${activeTab==='offices'?'bg-indigo-600':'hover:bg-slate-800'}`}><Building/> Oficinas</button>
                            <button onClick={()=>setActiveTab('support')} className={`w-full flex gap-3 p-3 rounded ${activeTab==='support'?'bg-indigo-600':'hover:bg-slate-800'}`}><LifeBuoy/> Mesa de Ayuda</button>
                        </nav>
                        <div className="p-4 bg-slate-950">
                            <p className="text-xs text-slate-500 font-bold mb-2">MODO (DEMO)</p>
                            <div className="flex gap-2">
                                <button onClick={()=>setUserRole('admin')} className={`px-2 py-1 text-xs rounded ${userRole==='admin'?'bg-emerald-600':'bg-slate-800'}`}>Admin</button>
                                <button onClick={()=>setUserRole('consultor')} className={`px-2 py-1 text-xs rounded ${userRole==='consultor'?'bg-blue-600':'bg-slate-800'}`}>Consultor</button>
                            </div>
                            <button onClick={()=>{localStorage.removeItem('apertura_firebase_config');location.reload()}} className="mt-3 text-xs text-red-400 hover:underline">Desconectar</button>
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 flex flex-col bg-slate-50">
                        <header className="bg-white border-b p-4 flex justify-between items-center shadow-sm">
                            <h2 className="font-bold text-xl capitalize">{activeTab}</h2>
                            <div className="flex gap-2">
                                <button onClick={exportExcel} className="flex gap-2 items-center bg-emerald-600 text-white px-4 py-2 rounded shadow hover:bg-emerald-700"><Download size={18}/> <span className="hidden sm:inline">Excel</span></button>
                                {activeTab==='offices' && canEdit && <button onClick={()=>{setCurrentOffice(null); setOfficeForm({name:'', address:'', contractEndDate:'', landlordName:'', notes:'', companies:[]}); setShowOfficeModal(true)}} className="flex gap-2 items-center bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700"><Plus size={18}/> Oficina</button>}
                                {activeTab==='support' && <button onClick={()=>{setCurrentTicket(null); setTicketForm({officeId:'', priority:'media', status:'pendiente', category:'internet', description:'', updates:[], newUpdate:''}); setShowTicketModal(true)}} className="flex gap-2 items-center bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700"><Plus size={18}/> Ticket</button>}
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto p-6">
                            {activeTab === 'dashboard' && (
                                <div className="max-w-6xl mx-auto space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="bg-white p-4 rounded shadow border"><p className="text-xs text-slate-500 font-bold">EMPRESAS</p><h3 className="text-2xl font-bold">{offices.reduce((a,b)=>a+(safeCompanies(b).length),0)}</h3></div>
                                        <div className="bg-white p-4 rounded shadow border"><p className="text-xs text-slate-500 font-bold">ESPACIOS</p><h3 className="text-2xl font-bold text-indigo-600">{(offices.length*5)-offices.reduce((a,b)=>a+(safeCompanies(b).length),0)}</h3></div>
                                        <div className="bg-white p-4 rounded shadow border"><p className="text-xs text-slate-500 font-bold">ALERTAS</p><h3 className="text-2xl font-bold text-amber-500">{alerts.length}</h3></div>
                                        <div className="bg-white p-4 rounded shadow border"><p className="text-xs text-slate-500 font-bold">TICKETS</p><h3 className="text-2xl font-bold text-slate-700">{tickets.filter(t=>t.status!=='resuelto').length}</h3></div>
                                    </div>
                                    <div className="bg-white rounded shadow border">
                                        <div className="p-4 border-b font-bold flex gap-2 items-center"><AlertTriangle size={18} className="text-amber-500"/> Alertas Pendientes</div>
                                        {alerts.length===0 ? <div className="p-8 text-center text-slate-400">Todo en orden</div> : 
                                            alerts.map((a,i)=>(
                                                <div key={i} className="p-4 border-b flex justify-between items-center hover:bg-slate-50">
                                                    <div><p className="font-bold">{a.title}</p><p className="text-sm text-slate-600">{a.msg}</p></div>
                                                    {canEdit && (a.actionType?.includes('Check') ? <button onClick={()=>performQuickCheck(a.data.officeId, a.data.companyIndex, a.actionType.includes('Phone')?'phone':'web')} className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Revisar</button> : <button onClick={()=>{setActiveTab('offices'); if(a.type==='contract'){setCurrentOffice(a.data); setShowOfficeModal(true)} }} className="text-indigo-600 text-sm font-bold">Ver</button>)}
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            )}

                            {activeTab === 'offices' && (
                                <div className="max-w-6xl mx-auto space-y-6">
                                    <div className="relative"><Search className="absolute left-3 top-3 text-slate-400" size={18}/><input className="w-full pl-10 p-3 rounded border shadow-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Buscar oficina o empresa..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/></div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {offices.filter(o=>o.name.toLowerCase().includes(searchTerm.toLowerCase()) || safeCompanies(o).some(c=>c.name.toLowerCase().includes(searchTerm.toLowerCase()))).map(o=>(
                                            <div key={o.id} className="bg-white rounded border shadow-sm">
                                                <div className="p-4 border-b bg-slate-50 flex justify-between items-start">
                                                    <div><h3 className="font-bold text-lg">{o.name}</h3><p className="text-xs text-slate-500">{o.address}</p></div>
                                                    <div className="text-right">
                                                        <span className="text-xs font-bold px-2 py-1 bg-white border rounded">{(safeCompanies(o).length)}/5</span>
                                                        {canEdit && <div className="mt-2 flex gap-2 justify-end"><button onClick={()=>{setCurrentOffice(o); setOfficeForm(o); setShowOfficeModal(true)}}><Edit size={16} className="text-slate-400 hover:text-indigo-600"/></button><button onClick={()=>deleteOffice(o.id)}><Trash2 size={16} className="text-slate-400 hover:text-red-600"/></button></div>}
                                                    </div>
                                                </div>
                                                <div className="p-4 space-y-2">
                                                    {safeCompanies(o).map((c,i)=>(
                                                        <div key={i} className="border p-2 rounded flex justify-between items-center bg-white hover:shadow-sm">
                                                            <div>
                                                                <p className="font-bold text-sm flex items-center gap-1">{c.isLeader && <Crown size={12} className="text-amber-500 fill-amber-500"/>} {c.name}</p>
                                                                <div className="flex gap-2 text-[10px] text-slate-400"><span className={c.checklist?.phoneInstalled?'text-emerald-500':'text-slate-300'}>TEL</span><span className={c.checklist?.webCreated?'text-indigo-500':'text-slate-300'}>WEB</span></div>
                                                            </div>
                                                            <div className="flex gap-1">{canEdit ? <><button onClick={()=>{setCurrentOffice(o); setCurrentCompany({index:i}); setCompanyForm(c); setShowCompanyModal(true)}}><Edit size={14} className="text-indigo-400"/></button><button onClick={()=>deleteCompany(o.id,i)}><Trash2 size={14} className="text-red-300 hover:text-red-500"/></button></> : <button onClick={()=>{setCurrentOffice(o); setCurrentCompany({index:i}); setCompanyForm(c); setShowCompanyModal(true)}}><Eye size={14} className="text-slate-400"/></button>}</div>
                                                        </div>
                                                    ))}
                                                    {(!safeCompanies(o).length) && <div className="text-center text-xs italic text-slate-300 py-2">Vacía</div>}
                                                    {canEdit && (safeCompanies(o).length)<5 && <button onClick={()=>{setCurrentOffice(o); setCurrentCompany(null); setCompanyForm({name:'', isLeader:false, interior:'', assignmentDate:new Date().toISOString().split('T')[0], checklist:{telmexProof:false, fiscalAddressEmail:false, interiorAssigned:false, emailCreated:false, webCreated:false, phoneInstalled:false}, webUrl:'', domainExpirationDate:'', phoneNumber:''}); setShowCompanyModal(true)}} className="w-full border-2 border-dashed py-1 text-xs font-bold text-indigo-400 hover:bg-indigo-50 rounded">Agrega Empresa</button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'support' && (
                                <div className="max-w-4xl mx-auto space-y-4">
                                    {tickets.length===0 ? <div className="text-center py-10 text-slate-400"><LifeBuoy size={40} className="mx-auto mb-2 opacity-50"/><p>No hay tickets activos</p></div> : 
                                        tickets.map(t => (
                                            <div key={t.id} className={`bg-white p-4 rounded border shadow-sm flex gap-4 ${t.status==='resuelto'?'opacity-60':''}`}>
                                                <div className={`p-3 rounded-full h-fit ${t.status==='pendiente'?'bg-red-100 text-red-600':t.status==='proceso'?'bg-blue-100 text-blue-600':'bg-emerald-100 text-emerald-600'}`}><AlertCircle/></div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between">
                                                        <div><span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded mr-2 ${t.priority==='urgente'?'bg-red-500 text-white':'bg-slate-100'}`}>{t.priority}</span><h4 className="font-bold text-lg mt-1">{t.category}</h4></div>
                                                        <div className="text-right text-xs text-slate-400"><p>{t.officeName}</p><p>{formatDateTime(t.createdAt)}</p></div>
                                                    </div>
                                                    <p className="text-sm text-slate-600 mt-2">{t.description}</p>
                                                    {t.updates?.length>0 && <div className="mt-3 bg-slate-50 p-2 rounded text-xs border"><span className="font-bold flex gap-1 items-center mb-1"><History size={10}/> Último:</span>"{t.updates[t.updates.length-1].text}"</div>}
                                                    <div className="mt-3 flex gap-2">
                                                        <button onClick={()=>{setCurrentTicket(t); setTicketForm({...t, newUpdate:''}); setShowTicketModal(true)}} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700">Ver / Atender</button>
                                                        {canDelete && <button onClick={()=>deleteTicket(t.id)} className="text-red-400 text-xs hover:underline">Eliminar</button>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    }
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODAL OFICINA */}
                    {showOfficeModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={saveOffice} className="bg-white w-full max-w-md rounded-xl shadow-2xl p-6 space-y-4">
                                <h3 className="font-bold text-lg border-b pb-2">{currentOffice?'Editar':'Nueva'} Oficina</h3>
                                <fieldset disabled={!canEdit} className="space-y-3">
                                    <input className="w-full border p-2 rounded" placeholder="Nombre" value={officeForm.name} onChange={e=>setOfficeForm({...officeForm, name:e.target.value})} required/>
                                    <input className="w-full border p-2 rounded" placeholder="Dirección" value={officeForm.address} onChange={e=>setOfficeForm({...officeForm, address:e.target.value})} required/>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="date" className="border p-2 rounded w-full" value={officeForm.contractEndDate} onChange={e=>setOfficeForm({...officeForm, contractEndDate:e.target.value})}/>
                                        <input className="border p-2 rounded w-full" placeholder="Arrendador" value={officeForm.landlordName} onChange={e=>setOfficeForm({...officeForm, landlordName:e.target.value})}/>
                                    </div>
                                    <textarea className="w-full border p-2 rounded h-20" placeholder="Notas" value={officeForm.notes} onChange={e=>setOfficeForm({...officeForm, notes:e.target.value})}/>
                                </fieldset>
                                <div className="flex justify-end gap-2 pt-2">
                                    <button type="button" onClick={()=>setShowOfficeModal(false)} className="px-4 py-2 border rounded">Cerrar</button>
                                    {canEdit && <button className="px-4 py-2 bg-indigo-600 text-white rounded font-bold">Guardar</button>}
                                </div>
                            </form>
                        </div>
                    )}

                    {/* MODAL EMPRESA */}
                    {showCompanyModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={saveCompany} className="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-lg border-b pb-2">{currentCompany?'Editar':'Nueva'} Empresa</h3>
                                <fieldset disabled={!canEdit} className="space-y-3">
                                    <div className="grid grid-cols-3 gap-2">
                                        <input className="col-span-2 border p-2 rounded" placeholder="Nombre" value={companyForm.name} onChange={e=>setCompanyForm({...companyForm, name:e.target.value})} required/>
                                        <input className="border p-2 rounded" placeholder="Interior" value={companyForm.interior} onChange={e=>setCompanyForm({...companyForm, interior:e.target.value})}/>
                                    </div>
                                    <label className="flex items-center gap-2 text-sm font-bold text-amber-600"><input type="checkbox" checked={companyForm.isLeader} onChange={e=>setCompanyForm({...companyForm, isLeader:e.target.checked})}/> Empresa Líder</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="border p-2 rounded" placeholder="Teléfono" value={companyForm.phoneNumber} onChange={e=>setCompanyForm({...companyForm, phoneNumber:e.target.value})}/>
                                        <input className="border p-2 rounded" placeholder="Web URL" value={companyForm.webUrl} onChange={e=>setCompanyForm({...companyForm, webUrl:e.target.value})}/>
                                        <div className="col-span-2 text-xs font-bold text-slate-500 mt-2">Checklist de Alta:</div>
                                        {Object.keys(companyForm.checklist).map(k=>(<label key={k} className="flex gap-2 items-center text-sm capitalize"><input type="checkbox" checked={companyForm.checklist[k]} onChange={e=>setCompanyForm({...companyForm, checklist:{...companyForm.checklist, [k]:e.target.checked}})}/> {k.replace(/([A-Z])/g, ' $1')}</label>))}
                                    </div>
                                </fieldset>
                                <div className="flex justify-end gap-2 pt-2">
                                    <button type="button" onClick={()=>setShowCompanyModal(false)} className="px-4 py-2 border rounded">Cerrar</button>
                                    {canEdit && <button className="px-4 py-2 bg-indigo-600 text-white rounded font-bold">Guardar</button>}
                                </div>
                            </form>
                        </div>
                    )}

                    {/* MODAL TICKET */}
                    {showTicketModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={saveTicket} className="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-lg border-b pb-2">{currentTicket?'Atender':'Nuevo'} Ticket</h3>
                                {!currentTicket ? (
                                    <>
                                        <div className="grid grid-cols-2 gap-2">
                                            <select className="border p-2 rounded" value={ticketForm.category} onChange={e=>setTicketForm({...ticketForm, category:e.target.value})}><option value="internet">Internet</option><option value="telefono">Teléfono</option><option value="otro">Otro</option></select>
                                            <select className="border p-2 rounded" value={ticketForm.priority} onChange={e=>setTicketForm({...ticketForm, priority:e.target.value})}><option value="media">Media</option><option value="alta">Alta</option><option value="urgente">Urgente</option></select>
                                        </div>
                                        <select className="border p-2 rounded w-full" value={ticketForm.officeId} onChange={e=>{const o=offices.find(x=>x.id===e.target.value); setTicketForm({...ticketForm, officeId:o.id, officeName:o.name, companyName:''})}} required><option value="">Selecciona Oficina...</option>{offices.map(o=><option key={o.id} value={o.id}>{o.name}</option>)}</select>
                                        <textarea className="w-full border p-2 rounded h-24" placeholder="Descripción..." value={ticketForm.description} onChange={e=>setTicketForm({...ticketForm, description:e.target.value})} required/>
                                    </>
                                ) : (
                                    <div className="space-y-3">
                                        <div className="bg-slate-50 p-3 rounded border text-sm italic">"{ticketForm.description}"</div>
                                        <div className="max-h-40 overflow-y-auto space-y-2 border-t pt-2">
                                            {ticketForm.updates?.map((u,i)=>(<div key={i} className="text-xs bg-white border p-2 rounded"><div className="flex justify-between font-bold text-slate-400"><span>{u.author}</span><span>{formatDateTime(u.date)}</span></div><p>{u.text}</p></div>))}
                                        </div>
                                        {ticketForm.status!=='resuelto' && (
                                            <div className="bg-indigo-50 p-3 rounded border border-indigo-100">
                                                <label className="font-bold text-indigo-900 text-sm">Nuevo Avance:</label>
                                                <textarea className="w-full border p-2 rounded bg-white mt-1" rows="2" value={ticketForm.newUpdate} onChange={e=>setTicketForm({...ticketForm, newUpdate:e.target.value})}/>
                                                <div className="flex items-center justify-end gap-2 mt-2"><label className="text-xs">Estado:</label><select className="border p-1 rounded text-xs" value={ticketForm.status} onChange={e=>setTicketForm({...ticketForm, status:e.target.value})}><option value="pendiente">Pendiente</option><option value="proceso">Proceso</option><option value="resuelto">Resolver</option></select></div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <div className="flex justify-end gap-2 pt-2">
                                    <button type="button" onClick={()=>setShowTicketModal(false)} className="px-4 py-2 border rounded">Cerrar</button>
                                    {(!currentTicket || ticketForm.status!=='resuelto' || ticketForm.newUpdate) && <button className="px-4 py-2 bg-indigo-600 text-white rounded font-bold">Guardar</button>}
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <AppContent />
            </ErrorBoundary>
        );
    </script>
</body>
</html>

