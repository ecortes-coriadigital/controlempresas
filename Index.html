<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORIA - AperturaMaster</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. SOLUCIÓN ERROR DE PROCESO (Polyfill para React 18) -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Import Map: Define de dónde bajan las librerías -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.303.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel: Permite leer el código React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            serverTimestamp,
            query,
            orderBy
        } from 'firebase/firestore';
        import { 
            LayoutDashboard, Building2, Building, AlertTriangle, Plus, Search, CheckCircle2, 
            XCircle, Globe, Phone, FileText, Users, MapPin, Trash2, Edit, Clock, Calendar, 
            Crown, ChevronDown, ChevronUp, MoreVertical, ClipboardList, ExternalLink, Info, 
            LifeBuoy, MessageSquare, AlertCircle, CheckSquare, Send, Download, ShieldAlert, 
            Eye, History, Settings, Save
        } from 'lucide-react';

        // --- 2. GESTIÓN DE CONFIGURACIÓN DE FIREBASE ---
        const getStoredConfig = () => {
            try {
                // Primero intentamos leer del entorno (Canvas)
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
                // Si no, buscamos en el almacenamiento local del navegador
                const local = localStorage.getItem('apertura_firebase_config');
                if (local) return JSON.parse(local);
            } catch (e) { console.error(e); }
            return null;
        };

        const config = getStoredConfig();
        let app, auth, db, isConfigured = false;

        if (config && config.apiKey) {
            try {
                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                isConfigured = true;
            } catch (e) {
                console.error("Error iniciando Firebase con config guardada:", e);
                localStorage.removeItem('apertura_firebase_config'); // Limpiar si está corrupta
            }
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Utilidades ---
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const offsetDate = new Date(date.getTime() + userTimezoneOffset);
            return offsetDate.toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });
        };

        const formatDateTime = (timestamp) => {
            if (!timestamp) return 'Justo ahora';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const getDaysDiff = (dateString) => {
            if (!dateString) return null;
            const target = new Date(dateString);
            const today = new Date();
            const diffTime = target - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

        const getDaysSince = (dateString) => {
            if (!dateString) return 999; 
            const past = new Date(dateString);
            const today = new Date();
            const diffTime = today - past;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        };

        // --- PANTALLA DE CONFIGURACIÓN (Si falla la carga) ---
        function ConfigScreen() {
            const [jsonInput, setJsonInput] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    // Intenta extraer el objeto JSON del texto pegado (incluso si pegan "const firebaseConfig = { ... }")
                    let cleanJson = jsonInput;
                    if (jsonInput.includes('=')) {
                        cleanJson = jsonInput.substring(jsonInput.indexOf('=') + 1);
                        if (cleanJson.trim().endsWith(';')) cleanJson = cleanJson.trim().slice(0, -1);
                    }
                    
                    // Limpieza básica de claves sin comillas (formato JS a JSON)
                    // Nota: Esto es básico, lo ideal es pegar JSON puro
                    const parsed = JSON.parse(cleanJson);
                    
                    if (!parsed.apiKey) throw new Error("Falta apiKey");
                    
                    localStorage.setItem('apertura_firebase_config', JSON.stringify(parsed));
                    window.location.reload(); // Recargar para aplicar
                } catch (e) {
                    setError("El formato no es válido. Asegúrate de pegar el objeto JSON de Firebase. " + e.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full border border-slate-200">
                        <div className="flex justify-center mb-6">
                            <div className="bg-indigo-100 p-4 rounded-full">
                                <Settings className="w-10 h-10 text-indigo-600" />
                            </div>
                        </div>
                        <h1 className="text-2xl font-bold text-center text-slate-800 mb-2">Configuración Inicial</h1>
                        <p className="text-slate-500 text-center mb-6 text-sm">
                            Para conectar <strong>AperturaMaster</strong> a tu base de datos, pega aquí la configuración de tu proyecto Firebase.
                        </p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-700 uppercase mb-1">Configuración Firebase (JSON)</label>
                                <textarea 
                                    className="w-full border border-slate-300 rounded-lg p-3 text-xs font-mono h-32 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    placeholder='{ "apiKey": "...", "authDomain": "...", ... }'
                                    value={jsonInput}
                                    onChange={e => setJsonInput(e.target.value)}
                                ></textarea>
                            </div>
                            
                            {error && (
                                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-start gap-2">
                                    <AlertCircle size={16} className="mt-0.5 shrink-0"/>
                                    {error}
                                </div>
                            )}

                            <button 
                                onClick={handleSave}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-200"
                            >
                                <Save size={18}/> Guardar y Conectar
                            </button>
                        </div>
                        
                        <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                            <p className="text-xs text-slate-400">
                                ¿No tienes los datos? Ve a <a href="https://console.firebase.google.com" target="_blank" className="text-indigo-500 underline">Firebase Console</a> &gt; Configuración del Proyecto.
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL ---
        function AperturaMaster() {
            // Si no hay config, mostramos pantalla de configuración
            if (!isConfigured) return <ConfigScreen />;

            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('admin');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [offices, setOffices] = useState([]);
            const [tickets, setTickets] = useState([]); 
            const [loading, setLoading] = useState(true);
            
            // Modales
            const [showOfficeModal, setShowOfficeModal] = useState(false);
            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [showTicketModal, setShowTicketModal] = useState(false); 
            
            const [currentOffice, setCurrentOffice] = useState(null);
            const [currentCompany, setCurrentCompany] = useState(null); 
            const [currentTicket, setCurrentTicket] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // Estados Formularios (Idénticos al anterior)
            const initialOfficeState = { name: '', address: '', contractEndDate: '', landlordName: '', notes: '', companies: [] };
            const initialCompanyState = { name: '', isLeader: false, interior: '', assignmentDate: new Date().toISOString().split('T')[0], checklist: { telmexProof: false, fiscalAddressEmail: false, interiorAssigned: false, emailCreated: false, webCreated: false, phoneInstalled: false }, webUrl: '', domainExpirationDate: '', lastWebCheck: new Date().toISOString().split('T')[0], phoneNumber: '', lastPhoneCheck: new Date().toISOString().split('T')[0] };
            const initialTicketState = { officeId: '', officeName: '', companyName: '', type: 'falla_tecnica', category: 'internet', priority: 'media', status: 'pendiente', description: '', updates: [], newUpdate: '' };

            const [officeForm, setOfficeForm] = useState(initialOfficeState);
            const [companyForm, setCompanyForm] = useState(initialCompanyState);
            const [ticketForm, setTicketForm] = useState(initialTicketState);

            // Auth Effect
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                        setLoading(false);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) setLoading(false);
                });
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!user) return;
                const unsubOffices = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'offices_v3'), 
                    (snap) => { setOffices(snap.docs.map(d => ({id: d.id, ...d.data()}))); if (!tickets.length) setLoading(false); },
                    (err) => { console.error(err); setLoading(false); }
                );
                const unsubTickets = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tickets'),
                    (snap) => { 
                        const docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        setTickets(docs);
                        setLoading(false);
                    },
                    (err) => console.error(err)
                );
                return () => { unsubOffices(); unsubTickets(); };
            }, [user]);

            // ... Lógica de negocio (Permisos, Exportar, Alertas, CRUD) ...
            // (Misma lógica que la versión anterior, resumida para brevedad en esta vista de "solución de error")
            const canEdit = userRole === 'admin'; 
            const canDelete = userRole === 'admin';

            const exportDataToCSV = () => {
                const headers = ['ID', 'Oficina', 'Dirección', 'Arrendador', 'Fin Contrato', 'Notas', 'Empresa', 'Líder', 'Int', 'Asignada', 'Tel', 'Web', 'URL', 'Venc.Dom', 'Num.Tel'];
                let csv = headers.join(",") + "\n";
                offices.forEach(off => {
                    const base = [`"${off.id}"`, `"${off.name}"`, `"${off.address}"`, `"${off.landlordName}"`, `"${off.contractEndDate}"`, `"${off.notes}"`];
                    if(!off.companies?.length) csv += base.join(",") + ",,,,,,,,,\n";
                    else off.companies.forEach(c => csv += [...base, `"${c.name}"`, c.isLeader?'SI':'NO', `"${c.interior}"`, `"${c.assignmentDate}"`, c.checklist?.phoneInstalled?'SI':'NO', c.checklist?.webCreated?'SI':'NO', `"${c.webUrl}"`, `"${c.domainExpirationDate}"`, `"${c.phoneNumber}"`].join(",") + "\n");
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([`\uFEFF${csv}`], {type: 'text/csv;charset=utf-8;'}));
                link.download = `Reporte_Aperturas_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const alerts = useMemo(() => {
                const list = [];
                offices.forEach(o => {
                    if(o.contractEndDate && getDaysDiff(o.contractEndDate) <= 90) list.push({ id: `c-${o.id}`, priority: getDaysDiff(o.contractEndDate)<=30?1:2, type: getDaysDiff(o.contractEndDate)<=30?'critical':'warning', title: `Contrato: ${o.name}`, msg: `Vence el ${formatDate(o.contractEndDate)}`, actionType: 'editOffice', data: o });
                    o.companies?.forEach((c,i) => {
                        if(c.domainExpirationDate && getDaysDiff(c.domainExpirationDate) <= 90) list.push({ id: `d-${o.id}-${i}`, priority: 2, type: 'warning', title: `Dominio: ${c.name}`, msg: `Vence: ${formatDate(c.domainExpirationDate)}`, actionType: 'editCompany', data: {officeId:o.id, companyIndex:i, data:c} });
                        if(c.checklist?.phoneInstalled && getDaysSince(c.lastPhoneCheck) >= 15) list.push({ id: `p-${o.id}-${i}`, priority: 1, type: 'action', title: `Teléfono: ${c.name}`, msg: `Revisar línea (última: ${formatDate(c.lastPhoneCheck)})`, actionType: 'quickCheckPhone', data: {officeId:o.id, companyIndex:i} });
                        if(c.checklist?.webCreated && getDaysSince(c.lastWebCheck) >= 30) list.push({ id: `w-${o.id}-${i}`, priority: 3, type: 'action', title: `Web: ${c.name}`, msg: `Revisar sitio (última: ${formatDate(c.lastWebCheck)})`, actionType: 'quickCheckWeb', data: {officeId:o.id, companyIndex:i} });
                    });
                });
                return list.sort((a,b) => a.priority - b.priority);
            }, [offices]);

            const saveOffice = async (e) => { e.preventDefault(); if(!canEdit) return; const ref = collection(db, 'artifacts', appId, 'public', 'data', 'offices_v3'); const payload = { ...officeForm, updatedAt: serverTimestamp() }; if(currentOffice) await updateDoc(doc(ref, currentOffice.id), payload); else await addDoc(ref, { ...payload, createdAt: serverTimestamp(), companies: [] }); setShowOfficeModal(false); };
            const saveCompany = async (e) => { e.preventDefault(); if(!canEdit || !currentOffice) return; const ref = doc(db, 'artifacts', appId, 'public', 'data', 'offices_v3', currentOffice.id); let comps = [...(currentOffice.companies||[])]; if(!currentCompany && comps.length>=5) return alert("Lleno"); if(companyForm.isLeader) comps = comps.map(c=>({...c, isLeader:false})); if(currentCompany) comps[currentCompany.companyIndex] = companyForm; else comps.push(companyForm); await updateDoc(ref, {companies: comps}); setShowCompanyModal(false); };
            const saveTicket = async (e) => { e.preventDefault(); const ref = collection(db, 'artifacts', appId, 'public', 'data', 'tickets'); const data = { ...ticketForm, updatedAt: serverTimestamp() }; if(ticketForm.newUpdate) data.updates = [...(ticketForm.updates||[]), {text: ticketForm.newUpdate, date: new Date().toISOString(), author: userRole==='admin'?'Admin':'Consultor'}]; delete data.newUpdate; if(currentTicket) await updateDoc(doc(ref, currentTicket.id), data); else await addDoc(ref, {...data, createdAt: serverTimestamp(), updates: []}); setShowTicketModal(false); };
            const deleteOffice = async (id) => { if(canDelete && confirm("¿Borrar todo?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'offices_v3', id)); };
            const deleteCompany = async (oid, idx) => { if(canDelete && confirm("¿Borrar empresa?")) { const o = offices.find(x=>x.id===oid); const comps = o.companies.filter((_,i)=>i!==idx); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'offices_v3', oid), {companies: comps}); } };
            const performQuickCheck = async (oid, idx, type) => { if(!canEdit) return; const o = offices.find(x=>x.id===oid); const comps = [...o.companies]; const key = type==='phone'?'lastPhoneCheck':'lastWebCheck'; comps[idx][key] = new Date().toISOString().split('T')[0]; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'offices_v3', oid), {companies: comps}); };

            // --- RENDERIZADO UI (Simplificado igual que antes pero con lógica completa) ---
            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">Cargando...</div>;

            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    <aside className="w-20 lg:w-64 bg-slate-900 text-white flex flex-col shadow-2xl">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-center lg:justify-start gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg"><Building2 className="w-6 h-6"/></div>
                            <h1 className="hidden lg:block font-bold">CORIA<br/><span className="text-indigo-400">Aperturas</span></h1>
                        </div>
                        <nav className="flex-1 p-2 space-y-2">
                            <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex items-center gap-3 p-3 rounded transition-all ${activeTab==='dashboard'?'bg-indigo-600':'hover:bg-slate-800'}`}><LayoutDashboard size={20}/><span className="hidden lg:inline">Tablero</span></button>
                            <button onClick={()=>setActiveTab('offices')} className={`w-full flex items-center gap-3 p-3 rounded transition-all ${activeTab==='offices'?'bg-indigo-600':'hover:bg-slate-800'}`}><Building size={20}/><span className="hidden lg:inline">Oficinas</span></button>
                            <button onClick={()=>setActiveTab('support')} className={`w-full flex items-center gap-3 p-3 rounded transition-all ${activeTab==='support'?'bg-indigo-600':'hover:bg-slate-800'}`}><LifeBuoy size={20}/><span className="hidden lg:inline">Mesa de Ayuda</span></button>
                        </nav>
                        <div className="p-4 bg-slate-950 text-center lg:text-left">
                            <p className="text-[10px] text-slate-500 font-bold mb-2">ROL ACTUAL</p>
                            <div className="flex flex-col gap-2">
                                <button onClick={()=>setUserRole('admin')} className={`px-2 py-1 rounded text-xs font-bold ${userRole==='admin'?'bg-emerald-600':'bg-slate-800'}`}>Admin</button>
                                <button onClick={()=>setUserRole('consultor')} className={`px-2 py-1 rounded text-xs font-bold ${userRole==='consultor'?'bg-blue-600':'bg-slate-800'}`}>Consultor</button>
                            </div>
                            <button onClick={()=>{localStorage.removeItem('apertura_firebase_config'); window.location.reload()}} className="mt-4 text-[10px] text-slate-600 hover:text-red-400 underline">Desconectar BD</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b px-6 py-4 flex justify-between items-center shrink-0">
                            <h2 className="text-xl font-bold">{activeTab==='dashboard'?'Tablero':activeTab==='offices'?'Oficinas':'Soporte'}</h2>
                            <div className="flex gap-2">
                                <button onClick={exportDataToCSV} className="bg-emerald-600 text-white px-3 py-2 rounded flex gap-2 text-sm font-bold items-center"><Download size={16}/> <span className="hidden sm:inline">Excel</span></button>
                                {activeTab==='offices' && canEdit && <button onClick={()=>{setCurrentOffice(null); setOfficeForm(initialOfficeState); setShowOfficeModal(true)}} className="bg-indigo-600 text-white px-3 py-2 rounded flex gap-2 text-sm font-bold items-center"><Plus size={16}/> <span className="hidden sm:inline">Nueva Oficina</span></button>}
                                {activeTab==='support' && <button onClick={()=>{setCurrentTicket(null); setTicketForm(initialTicketState); setShowTicketModal(true)}} className="bg-indigo-600 text-white px-3 py-2 rounded flex gap-2 text-sm font-bold items-center"><Plus size={16}/> <span className="hidden sm:inline">Ticket</span></button>}
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6">
                            {/* DASHBOARD */}
                            {activeTab === 'dashboard' && (
                                <div className="max-w-6xl mx-auto space-y-6">
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-white p-4 rounded shadow-sm border"><p className="text-xs text-slate-500 font-bold">EMPRESAS</p><h3 className="text-2xl font-bold">{offices.reduce((a,o)=>a+(o.companies?.length||0),0)}</h3></div>
                                        <div className="bg-white p-4 rounded shadow-sm border"><p className="text-xs text-slate-500 font-bold">ESPACIOS</p><h3 className="text-2xl font-bold text-indigo-600">{(offices.length*5)-offices.reduce((a,o)=>a+(o.companies?.length||0),0)}</h3></div>
                                        <div className="bg-white p-4 rounded shadow-sm border"><p className="text-xs text-slate-500 font-bold">ALERTAS</p><h3 className="text-2xl font-bold text-amber-500">{alerts.length}</h3></div>
                                        <div className="bg-white p-4 rounded shadow-sm border"><p className="text-xs text-slate-500 font-bold">TICKETS</p><h3 className="text-2xl font-bold text-slate-700">{tickets.filter(t=>t.status!=='resuelto').length}</h3></div>
                                    </div>
                                    {alerts.length > 0 && (
                                        <div className="bg-white rounded shadow-sm border overflow-hidden">
                                            <div className="bg-slate-50 px-4 py-2 border-b font-bold text-sm flex gap-2 items-center"><AlertCircle size={16} className="text-amber-500"/> Alertas Pendientes</div>
                                            <div className="divide-y">
                                                {alerts.map((a,i) => (
                                                    <div key={i} className="p-3 flex justify-between items-center hover:bg-slate-50">
                                                        <div><p className="font-bold text-sm">{a.title}</p><p className="text-xs text-slate-500">{a.msg}</p></div>
                                                        {canEdit && (a.actionType.includes('Check') ? <button onClick={()=>performQuickCheck(a.data.officeId, a.data.companyIndex, a.actionType.includes('Phone')?'phone':'web')} className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Revisar</button> : <button onClick={()=>{setActiveTab('offices'); setCurrentOffice(a.data); setShowOfficeModal(true)}} className="bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs">Ver</button>)}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* OFICINAS */}
                            {activeTab === 'offices' && (
                                <div className="max-w-7xl mx-auto space-y-4">
                                    <div className="relative max-w-md"><Search className="absolute left-3 top-2.5 text-slate-400" size={18}/><input className="w-full pl-10 pr-4 py-2 border rounded shadow-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Buscar..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                        {offices.filter(o=>o.name.toLowerCase().includes(searchTerm.toLowerCase())||o.companies?.some(c=>c.name.toLowerCase().includes(searchTerm.toLowerCase()))).map(o => (
                                            <div key={o.id} className="bg-white rounded border shadow-sm flex flex-col">
                                                <div className="p-4 border-b bg-slate-50 flex justify-between">
                                                    <div><h3 className="font-bold">{o.name}</h3><p className="text-xs text-slate-500">{o.address}</p></div>
                                                    <div className="text-right">{canEdit && <div className="flex gap-1 justify-end mb-1"><button onClick={()=>{setCurrentOffice(o); setOfficeForm(o); setShowOfficeModal(true)}}><Edit size={14} className="text-slate-400 hover:text-indigo-500"/></button><button onClick={()=>deleteOffice(o.id)}><Trash2 size={14} className="text-slate-400 hover:text-red-500"/></button></div>}<span className="text-[10px] bg-white border px-2 py-0.5 rounded font-bold">{(o.companies?.length||0)}/5</span></div>
                                                </div>
                                                <div className="p-4 space-y-2 flex-1">
                                                    {o.companies?.map((c,i)=>(
                                                        <div key={i} className="border p-2 rounded flex justify-between items-center hover:shadow-sm bg-white">
                                                            <div>
                                                                <p className="font-bold text-sm flex gap-1 items-center">{c.isLeader && <Crown size={12} className="text-amber-500 fill-amber-500"/>} {c.name}</p>
                                                                <div className="flex gap-2 text-[10px] text-slate-400 mt-0.5"><span className={c.checklist?.phoneInstalled?'text-emerald-500':'text-slate-300'}>TEL</span><span className={c.checklist?.webCreated?'text-indigo-500':'text-slate-300'}>WEB</span></div>
                                                            </div>
                                                            <div className="flex gap-1">{canEdit ? <><button onClick={()=>openEditCompanyModal(o,c,i)}><Edit size={12} className="text-indigo-400"/></button><button onClick={()=>deleteCompany(o.id,i)}><Trash2 size={12} className="text-red-300 hover:text-red-500"/></button></> : <button onClick={()=>openEditCompanyModal(o,c,i)}><Eye size={12} className="text-slate-400"/></button>}</div>
                                                        </div>
                                                    ))}
                                                    {(!o.companies?.length) && <div className="text-center text-xs text-slate-300 py-4 italic">Vacía</div>}
                                                    {canEdit && (o.companies?.length||0)<5 && <button onClick={()=>{setCurrentOffice(o); setCurrentCompany(null); setCompanyForm(initialCompanyState); setShowCompanyModal(true)}} className="w-full border-2 border-dashed py-1.5 text-xs text-indigo-400 font-bold hover:bg-indigo-50 rounded">+ Empresa</button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* SOPORTE */}
                            {activeTab === 'support' && (
                                <div className="max-w-5xl mx-auto">
                                    {!tickets.length ? (
                                        <div className="text-center py-20 border-2 border-dashed rounded bg-white"><LifeBuoy className="mx-auto text-slate-300 mb-4" size={48}/><p className="text-slate-500">No hay tickets activos</p></div>
                                    ) : (
                                        <div className="space-y-4">
                                            {tickets.map(t => (
                                                <div key={t.id} className={`bg-white p-4 rounded border shadow-sm flex gap-4 ${t.status==='resuelto'?'opacity-60':''}`}>
                                                    <div className={`p-3 rounded-full h-fit shrink-0 ${t.status==='pendiente'?'bg-red-100 text-red-600':t.status==='proceso'?'bg-blue-100 text-blue-600':'bg-emerald-100 text-emerald-600'}`}><AlertCircle/></div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded mr-2 ${t.priority==='urgente'?'bg-red-500 text-white':'bg-slate-100 text-slate-600'}`}>{t.priority}</span>
                                                                <h4 className="font-bold text-lg inline">{t.category.toUpperCase()}</h4>
                                                                <p className="text-slate-600 mt-1">{t.description}</p>
                                                            </div>
                                                            <div className="text-right text-xs text-slate-400"><p>{t.officeName}</p><p>{formatDateTime(t.createdAt)}</p></div>
                                                        </div>
                                                        {t.updates?.length>0 && <div className="mt-3 bg-slate-50 p-2 rounded text-xs border"><span className="font-bold flex gap-1 items-center mb-1"><History size={10}/> Último avance:</span>"{t.updates[t.updates.length-1].text}"</div>}
                                                        <div className="mt-3 flex gap-2">
                                                            <button onClick={()=>{setCurrentTicket(t); setTicketForm({...t, newUpdate:''}); setShowTicketModal(true)}} className="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded font-bold hover:bg-indigo-700">Ver / Atender</button>
                                                            {canDelete && <button onClick={()=>deleteTicket(t.id)} className="text-xs text-red-400 hover:underline">Eliminar</button>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODALES (Simplificados para esta vista pero 100% funcionales) */}
                    {(showOfficeModal || showCompanyModal || showTicketModal) && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b bg-slate-50 flex justify-between font-bold">
                                    <span>{showOfficeModal?'Oficina':showCompanyModal?'Empresa':'Ticket'}</span>
                                    <button onClick={()=>{setShowOfficeModal(false);setShowCompanyModal(false);setShowTicketModal(false)}}><XCircle/></button>
                                </div>
                                <div className="p-6 overflow-y-auto">
                                    {showOfficeModal && (
                                        <form onSubmit={saveOffice} className="space-y-3">
                                            <fieldset disabled={!canEdit} className="space-y-3">
                                                <input className="w-full border p-2 rounded" placeholder="Nombre" value={officeForm.name} onChange={e=>setOfficeForm({...officeForm, name:e.target.value})} required/>
                                                <input className="w-full border p-2 rounded" placeholder="Dirección" value={officeForm.address} onChange={e=>setOfficeForm({...officeForm, address:e.target.value})} required/>
                                                <div className="grid grid-cols-2 gap-2"><input type="date" className="border p-2 rounded w-full" value={officeForm.contractEndDate} onChange={e=>setOfficeForm({...officeForm, contractEndDate:e.target.value})}/><input className="border p-2 rounded w-full" placeholder="Arrendador" value={officeForm.landlordName} onChange={e=>setOfficeForm({...officeForm, landlordName:e.target.value})}/></div>
                                                <textarea className="w-full border p-2 rounded h-20" placeholder="Notas" value={officeForm.notes} onChange={e=>setOfficeForm({...officeForm, notes:e.target.value})}/>
                                            </fieldset>
                                            <div className="pt-2 flex justify-end gap-2"><button type="button" onClick={()=>setShowOfficeModal(false)} className="px-4 py-2 border rounded">Cerrar</button>{canEdit && <button className="px-4 py-2 bg-indigo-600 text-white rounded font-bold">Guardar</button>}</div>
                                        </form>
                                    )}
                                    {showCompanyModal && (
                                        <form onSubmit={saveCompany} className="space-y-3">
                                            <fieldset disabled={!canEdit} className="space-y-3">
                                                <div className="grid grid-cols-3 gap-2"><input className="col-span-2 border p-2 rounded" placeholder="Nombre Empresa" value={companyForm.name} onChange={e=>setCompanyForm({...companyForm, name:e.target.value})} required/><input className="border p-2 rounded" placeholder="Interior" value={companyForm.interior} onChange={e=>setCompanyForm({...companyForm, interior:e.target.value})}/></div>
                                                <label className="flex items-center gap-2 text-sm font-bold text-amber-600"><input type="checkbox" checked={companyForm.isLeader} onChange={e=>setCompanyForm({...companyForm, isLeader:e.target.checked})}/> Empresa Líder (Contrato)</label>
                                                <div className="grid grid-cols-2 gap-2"><input className="border p-2 rounded" placeholder="Teléfono" value={companyForm.phoneNumber} onChange={e=>setCompanyForm({...companyForm, phoneNumber:e.target.value})}/><input className="border p-2 rounded" placeholder="Sitio Web" value={companyForm.webUrl} onChange={e=>setCompanyForm({...companyForm, webUrl:e.target.value})}/></div>
                                                <div className="bg-slate-50 p-2 rounded border grid grid-cols-2 gap-2 text-xs">
                                                    {Object.keys(companyForm.checklist).map(k=>(<label key={k} className="flex gap-1 items-center"><input type="checkbox" checked={companyForm.checklist[k]} onChange={e=>setCompanyForm({...companyForm, checklist:{...companyForm.checklist, [k]:e.target.checked}})}/> {k}</label>))}
                                                </div>
                                            </fieldset>
                                            <div className="pt-2 flex justify-end gap-2"><button type="button" onClick={()=>setShowCompanyModal(false)} className="px-4 py-2 border rounded">Cerrar</button>{canEdit && <button className="px-4 py-2 bg-indigo-600 text-white rounded font-bold">Guardar</button>}</div>
                                        </form>
                                    )}
                                    {showTicketModal && (
                                        <form onSubmit={saveTicket} className="space-y-4">
                                            {!currentTicket ? (
                                                <>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <select className="border p-2 rounded w-full" value={ticketForm.category} onChange={e=>setTicketForm({...ticketForm, category:e.target.value})}><option value="internet">Internet</option><option value="telefono">Teléfono</option><option value="otro">Otro</option></select>
                                                        <select className="border p-2 rounded w-full" value={ticketForm.priority} onChange={e=>setTicketForm({...ticketForm, priority:e.target.value})}><option value="media">Media</option><option value="alta">Alta</option><option value="urgente">Urgente</option></select>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <select className="border p-2 rounded w-full" value={ticketForm.officeId} onChange={e=>{const o=offices.find(x=>x.id===e.target.value);setTicketForm({...ticketForm, officeId:o.id, officeName:o.name, companyName:''})}}><option value="">Oficina...</option>{offices.map(o=><option key={o.id} value={o.id}>{o.name}</option>)}</select>
                                                        <select className="border p-2 rounded w-full" value={ticketForm.companyName} onChange={e=>setTicketForm({...ticketForm, companyName:e.target.value})} disabled={!ticketForm.officeId}><option value="">Empresa...</option>{offices.find(o=>o.id===ticketForm.officeId)?.companies?.map(c=><option key={c.name} value={c.name}>{c.name}</option>)}</select>
                                                    </div>
                                                    <textarea className="w-full border p-2 rounded h-24" placeholder="Descripción del problema..." value={ticketForm.description} onChange={e=>setTicketForm({...ticketForm, description:e.target.value})} required/>
                                                </>
                                            ) : (
                                                <div className="text-sm space-y-3">
                                                    <div className="bg-slate-50 p-3 rounded border"><strong>Problema:</strong> {ticketForm.description}</div>
                                                    <div className="max-h-40 overflow-y-auto space-y-2">
                                                        {ticketForm.updates?.map((u,i)=>(<div key={i} className="bg-white border p-2 rounded text-xs"><div className="flex justify-between font-bold text-slate-400"><span>{u.author}</span><span>{formatDateTime(u.date)}</span></div><p>{u.text}</p></div>))}
                                                    </div>
                                                    {ticketForm.status!=='resuelto' && (
                                                        <div className="bg-indigo-50 p-3 rounded border border-indigo-100">
                                                            <label className="font-bold text-indigo-900 block mb-1">Nuevo Avance:</label>
                                                            <textarea className="w-full border p-2 rounded bg-white" rows="2" value={ticketForm.newUpdate} onChange={e=>setTicketForm({...ticketForm, newUpdate:e.target.value})}/>
                                                            <div className="flex items-center gap-2 mt-2 justify-end"><label>Estado:</label><select className="border p-1 rounded text-xs" value={ticketForm.status} onChange={e=>setTicketForm({...ticketForm, status:e.target.value})}><option value="pendiente">Pendiente</option><option value="proceso">Proceso</option><option value="resuelto">Resolver</option></select></div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            <div className="pt-2 flex justify-end gap-2"><button type="button" onClick={()=>setShowTicketModal(false)} className="px-4 py-2 border rounded">Cerrar</button>{(!currentTicket || ticketForm.status!=='resuelto' || ticketForm.newUpdate) && <button className="px-4 py-2 bg-indigo-600 text-white rounded font-bold">Guardar</button>}</div>
                                        </form>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AperturaMaster />);
    </script>
</body>
</html>
